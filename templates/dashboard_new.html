{% extends "base.html" %}
{% block title %}{{ t('menu.dashboard') }}{% endblock %}

{% block body %}
<main class="container mb-5">
  {% if role == 'student' %}
  <h2>{{ t('dashboard.welcome') }}, {{ login }}!</h2>

    <div class="calories alert alert-info">{{ t('dashboard.remaining') }}: {{ calories }} {{ t('grams') }}</div>
    <div class="bju mb-3">
      <div>{{ t('food.protein') }}: {{ protein }} {{ t('grams') }}</div>
      <div>{{ t('food.fat') }}: {{ fat }} {{ t('grams') }}</div>
      <div>{{ t('food.carbs') }}: {{ carbs }} {{ t('grams') }}</div>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∏ –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞ -->
    <div class="btn-group mb-3">
      <a href="{{ url_for('eat') }}" class="btn btn-success">‚ûï {{ t('food.add_food') }}</a>
      <button id="toggleEdit" class="btn btn-outline-primary">‚öô {{ t('dashboard.nutrition_info') }}</button>
    </div>

    <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–ª—è —É—á–∏—Ç–µ–ª—è -->
    {% if is_teacher %}
    <div class="mt-2 mb-3">
      <hr>
      <h4>{{ t('dashboard.teacher_panel') }}</h4>
      <div class="btn-group">
        <a href="#" class="btn btn-primary">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–ª–∞—Å—Å–∞</a>
      </div>
    </div>
    {% endif %}

    <div class="edit-section mb-3" id="editSection" style="display:none;">
      <form method="POST" action="{{ url_for('update_calories') }}" class="row g-2">
        <div class="col-md-3">
          <label class="form-label">{{ t('food.calories') }}:</label>
          <input type="number" class="form-control" name="calories" min="0" value="{{ calories }}">
        </div>
        <div class="col-md-3">
          <label class="form-label">{{ t('food.protein') }} ({{ t('grams') }}):</label>
          <input type="number" class="form-control" name="protein" min="0" step="0.1" value="{{ protein }}">
        </div>
        <div class="col-md-3">
          <label class="form-label">{{ t('food.fat') }} ({{ t('grams') }}):</label>
          <input type="number" class="form-control" name="fat" min="0" step="0.1" value="{{ fat }}">
        </div>
        <div class="col-md-3">
          <label class="form-label">{{ t('food.carbs') }} ({{ t('grams') }}):</label>
          <input type="number" class="form-control" name="carbs" min="0" step="0.1" value="{{ carbs }}">
        </div>
        <div class="col-12 mt-2">
          <button type="submit" class="btn btn-primary">{{ t('actions.save') }}</button>
        </div>
      </form>
    </div>

    <h3>–í—ã —É–∂–µ —Å—ä–µ–ª–∏:</h3>
    <ul class="list-group">
      {% for item in eaten %}
        <li class="list-group-item">{{ item }}</li>
      {% endfor %}
    </ul>

  {% elif role == 'parent' %}
    <h2>–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, {{ login }}!</h2>
    
    <div class="mt-3 mb-3 d-flex gap-2">
      <a href="{{ url_for('parent_add_child') }}" class="btn btn-success">–î–æ–±–∞–≤–∏—Ç—å —Ä–µ–±—ë–Ω–∫–∞</a>
      <a href="{{ url_for('parent_children') }}" class="btn btn-outline-primary">–ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –¥–µ—Ç–µ–π</a>
    </div>

    <h3 class="mt-3">–ú–æ–∏ –¥–µ—Ç–∏</h3>
    <div class="row g-3">
      {% for child in children %}
        {% set sum = child_summaries.get(child.id) %}
        <div class="col-md-6">
          <div class="card h-100">
            <div class="card-body">
              <h5 class="card-title mb-3">{{ child.name or child.login }}</h5>
              
              <!-- –ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –ø–∏—Ç–∞–Ω–∏—è -->
              <div class="nutrition-info mb-3">
                <h6 class="mb-2">–°—ä–µ–¥–µ–Ω–æ —Å–µ–≥–æ–¥–Ω—è:</h6>
                <div class="row text-center g-2">
                  <div class="col-6 col-xl-3">
                    <div class="alert alert-info p-2 mb-2">
                      <div class="fw-bold">{{ sum.sum_cal }} –∫–∫–∞–ª</div>
                      <small>–∫–∞–ª–æ—Ä–∏–∏</small>
                    </div>
                  </div>
                  <div class="col-6 col-xl-3">
                    <div class="alert alert-info p-2 mb-2">
                      <div class="fw-bold">{{ sum.sum_prot }} –≥</div>
                      <small>–±–µ–ª–∫–∏</small>
                    </div>
                  </div>
                  <div class="col-6 col-xl-3">
                    <div class="alert alert-info p-2 mb-2">
                      <div class="fw-bold">{{ sum.sum_fat }} –≥</div>
                      <small>–∂–∏—Ä—ã</small>
                    </div>
                  </div>
                  <div class="col-6 col-xl-3">
                    <div class="alert alert-info p-2 mb-2">
                      <div class="fw-bold">{{ sum.sum_carbs }} –≥</div>
                      <small>—É–≥–ª–µ–≤–æ–¥—ã</small>
                    </div>
                  </div>
                </div>
                
                <h6 class="mb-2">–û—Å—Ç–∞–ª–æ—Å—å:</h6>
                <div class="row text-center g-2">
                  <div class="col-6 col-xl-3">
                    <div class="alert {% if sum.remaining_cal < 0 %}alert-danger{% else %}alert-success{% endif %} p-2 mb-2">
                      <div class="fw-bold">{{ sum.remaining_cal }} –∫–∫–∞–ª</div>
                      <small>–∫–∞–ª–æ—Ä–∏–∏</small>
                    </div>
                  </div>
                  <div class="col-6 col-xl-3">
                    <div class="alert {% if sum.remaining_prot < 0 %}alert-danger{% else %}alert-success{% endif %} p-2 mb-2">
                      <div class="fw-bold">{{ sum.remaining_prot }} –≥</div>
                      <small>–±–µ–ª–∫–∏</small>
                    </div>
                  </div>
                  <div class="col-6 col-xl-3">
                    <div class="alert {% if sum.remaining_fat < 0 %}alert-danger{% else %}alert-success{% endif %} p-2 mb-2">
                      <div class="fw-bold">{{ sum.remaining_fat }} –≥</div>
                      <small>–∂–∏—Ä—ã</small>
                    </div>
                  </div>
                  <div class="col-6 col-xl-3">
                    <div class="alert {% if sum.remaining_carbs < 0 %}alert-danger{% else %}alert-success{% endif %} p-2 mb-2">
                      <div class="fw-bold">{{ sum.remaining_carbs }} –≥</div>
                      <small>—É–≥–ª–µ–≤–æ–¥—ã</small>
                    </div>
                  </div>
                </div>
              </div>

              <!-- –°—ä–µ–¥–µ–Ω–Ω—ã–µ –±–ª—é–¥–∞ -->
              <div class="eaten-foods mb-3">
                <h6 class="mb-2">–°—ä–µ–¥–µ–Ω–Ω—ã–µ –±–ª—é–¥–∞:</h6>
                {% if child_logs.get(child.id) %}
                  <div class="list-group list-group-flush">
                    {% for log in child_logs.get(child.id) %}
                      <div class="list-group-item px-0">
                        <div class="fw-medium">{{ log.name }}</div>
                        <small class="text-muted">
                          {{ log.calories }} –∫–∫–∞–ª ¬∑ {{ log.protein }}–≥ –±–µ–ª–∫–æ–≤ ¬∑ 
                          {{ log.fat }}–≥ –∂–∏—Ä–æ–≤ ¬∑ {{ log.carbs }}–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤
                        </small>
                      </div>
                    {% endfor %}
                  </div>
                {% else %}
                  <p class="text-muted small">–°–µ–≥–æ–¥–Ω—è –µ—â—ë –Ω–∏—á–µ–≥–æ –Ω–µ —Å—ä–µ–¥–µ–Ω–æ</p>
                {% endif %}
              </div>
              
              <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
              <div class="d-flex gap-2">
                <div class="d-flex w-100 gap-2">
                  <a href="{{ url_for('export_child_year', student_id=child.id, fmt='doc') }}" 
                     class="btn btn-sm btn-outline-primary flex-grow-1" target="_blank" rel="noopener noreferrer">
                    ÔøΩ DOC
                  </a>
                  <a href="{{ url_for('export_child_year', student_id=child.id, fmt='excel') }}" 
                     class="btn btn-sm btn-outline-success" target="_blank" rel="noopener noreferrer">
                    üóí XLS/CSV
                  </a>
                </div>
                <a href="{{ url_for('parent_children') }}" 
                   class="btn btn-sm btn-outline-secondary">
                  üìã –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                </a>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>

  {% elif role == 'cook' %}
    <h2>–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, {{ get_role_display('cook') }} {{ login }}!</h2>
    <div class="info mb-3">–í—ã –º–æ–∂–µ—Ç–µ —É–ø—Ä–∞–≤–ª—è—Ç—å —à–∫–æ–ª—å–Ω—ã–º –º–µ–Ω—é.</div>
    <a href="{{ url_for('cook_menu') }}" class="btn btn-primary">–ü–µ—Ä–µ–π—Ç–∏ –≤ –º–µ–Ω—é {{ get_role_display('cook') }}</a>

  {% else %}
    <h2>–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —Ä–æ–ª—å</h2>
  {% endif %}
</main>

<script>
  document.getElementById("toggleEdit")?.addEventListener("click", function() {
    const editSection = document.getElementById("editSection");
    if(editSection.style.display === "none" || editSection.style.display === "") {
      editSection.style.display = "block";
      this.textContent = "‚úñ –ó–∞–∫—Ä—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏";
    } else {
      editSection.style.display = "none";
      this.textContent = "‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ö–ë–ñ–£";
    }
  });
</script>
{% endblock %}