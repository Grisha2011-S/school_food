{% extends "base.html" %}

{% block title %}Панель администратора{% endblock %}

{% block body %}
<div class="container-fluid mt-4">
    <!-- Верхняя панель -->
    <div class="row mb-4">
        <div class="col">
            <h2>Панель администратора</h2>
        </div>
        <div class="col text-end">
            {% if session.get('is_master_admin') %}
            <a href="{{ url_for('admin_create') }}" class="btn btn-primary">
                <i class="fas fa-user-plus"></i> Добавить администратора
            </a>
            {% endif %}
            <a href="{{ url_for('logout') }}" class="btn btn-outline-danger">
                <i class="fas fa-sign-out-alt"></i> Выход
            </a>
        </div>
    </div>

    <!-- Вкладки -->
    <ul class="nav nav-tabs" id="adminTabs" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" id="cities-tab" data-bs-toggle="tab" href="#cities" role="tab">
                Города
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="schools-tab" data-bs-toggle="tab" href="#schools" role="tab">
                Школы
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="grades-tab" data-bs-toggle="tab" href="#grades" role="tab">
                Классы
            </a>
        </li>
    </ul>

    <!-- Содержимое вкладок -->
    <div class="tab-content border border-top-0 rounded-bottom p-4">
        <!-- Города -->
        <div class="tab-pane fade show active" id="cities" role="tabpanel">
            <div class="d-flex justify-content-between mb-3">
                <h4>Список городов</h4>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCityModal">
                    <i class="fas fa-plus"></i> Добавить город
                </button>
            </div>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Название</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for city in cities %}
                        <tr>
                            <td>{{ city.name }}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" onclick="editCity({{ city.id }}, '{{ city.name }}')">
                                    Редактировать
                                </button>
                                <form method="post" action="{{ url_for('admin_delete_city', city_id=city.id) }}" class="d-inline">
                                    <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Удалить город?')">
                                        Удалить
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Школы -->
        <div class="tab-pane fade" id="schools" role="tabpanel">
            <div class="d-flex justify-content-between mb-3">
                <h4>Список школ</h4>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addSchoolModal">
                    <i class="fas fa-plus"></i> Добавить школу
                </button>
            </div>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Город</th>
                            <th>Название</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for school in schools %}
                        <tr>
                            <td>{{ school.city.name }}</td>
                            <td>{{ school.name }}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" onclick="editSchool({{ school.id }}, '{{ school.name }}', {{ school.city_id }})">
                                    Редактировать
                                </button>
                                <form method="post" action="{{ url_for('admin_delete_school', school_id=school.id) }}" class="d-inline">
                                    <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Удалить школу?')">
                                        Удалить
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Классы -->
        <div class="tab-pane fade" id="grades" role="tabpanel">
            <div class="d-flex justify-content-between mb-3">
                <h4>Список классов</h4>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addGradeModal">
                    <i class="fas fa-plus"></i> Добавить класс
                </button>
            </div>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Название</th>
                            <th>Школа</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for grade in grades %}
                        <tr>
                            <td>{{ grade.name }}</td>
                            <td>{{ grade.school.name if grade.school else '' }}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" onclick='editGrade({{ grade.id }}, {{ grade.name|tojson }}, {{ grade.school_id|tojson }})'>
                                    Редактировать
                                </button>
                                <form method="post" action="{{ url_for('admin_delete_grade', grade_id=grade.id) }}" class="d-inline">
                                    <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Удалить класс?')">
                                        Удалить
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Модальные окна -->
<!-- Добавление города -->
<div class="modal fade" id="addCityModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('admin_cities') }}">
                <div class="modal-header">
                    <h5 class="modal-title">Добавить город</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="cityName" class="form-label">Название города</label>
                        <input type="text" class="form-control" id="cityName" name="name" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary">Добавить</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Добавление школы -->
<div class="modal fade" id="addSchoolModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('admin_schools') }}">
                <div class="modal-header">
                    <h5 class="modal-title">Добавить школу</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="citySelect" class="form-label">Город</label>
                        <select class="form-select" id="citySelect" name="city_id" required>
                            <option value="">-- Выберите город --</option>
                            {% for city in cities %}
                            <option value="{{ city.id }}">{{ city.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="schoolName" class="form-label">Название школы</label>
                        <input type="text" class="form-control" id="schoolName" name="name" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary">Добавить</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Добавление класса -->
<div class="modal fade" id="addGradeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('admin_grades') }}">
                <div class="modal-header">
                    <h5 class="modal-title">Добавить класс</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="gradeName" class="form-label">Название класса</label>
                        <input type="text" class="form-control" id="gradeName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="gradeSchool" class="form-label">Школа</label>
                        <select class="form-select" id="gradeSchool" name="school_id" required>
                            {% for school in schools %}
                            <option value="{{ school.id }}">{{ school.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary">Добавить</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Редактирование города -->
<div class="modal fade" id="editCityModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" id="editCityForm">
                <div class="modal-header">
                    <h5 class="modal-title">Редактировать город</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editCityName" class="form-label">Название города</label>
                        <input type="text" class="form-control" id="editCityName" name="name" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary">Сохранить</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Редактирование школы -->
<div class="modal fade" id="editSchoolModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" id="editSchoolForm">
                <div class="modal-header">
                    <h5 class="modal-title">Редактировать школу</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editSchoolCity" class="form-label">Город</label>
                        <select class="form-select" id="editSchoolCity" name="city_id" required>
                            {% for city in cities %}
                            <option value="{{ city.id }}">{{ city.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editSchoolName" class="form-label">Название школы</label>
                        <input type="text" class="form-control" id="editSchoolName" name="name" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary">Сохранить</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Редактирование класса -->
<div class="modal fade" id="editGradeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" id="editGradeForm">
                <div class="modal-header">
                    <h5 class="modal-title">Редактировать класс</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editGradeName" class="form-label">Название класса</label>
                        <input type="text" class="form-control" id="editGradeName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="editGradeSchool" class="form-label">Школа</label>
                        <select class="form-select" id="editGradeSchool" name="school_id" required>
                            {% for school in schools %}
                            <option value="{{ school.id }}">{{ school.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary">Сохранить</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% block scripts %}
<script>
// Переключение вкладки по параметру tab
const urlParams = new URLSearchParams(window.location.search);
const tab = urlParams.get('tab');
if (tab) {
    const tabEl = document.getElementById(tab + '-tab');
    if (tabEl) {
        new bootstrap.Tab(tabEl).show();
    }
}

function editCity(id, name) {
    document.getElementById('editCityName').value = name;
    document.getElementById('editCityForm').action = `/admin/cities/edit/${id}`;
    new bootstrap.Modal(document.getElementById('editCityModal')).show();
}

function editSchool(id, name, cityId) {
    document.getElementById('editSchoolName').value = name;
    document.getElementById('editSchoolCity').value = cityId;
    document.getElementById('editSchoolForm').action = `/admin/schools/edit/${id}`;
    new bootstrap.Modal(document.getElementById('editSchoolModal')).show();
}

function editGrade(id, name, schoolId) {
    document.getElementById('editGradeName').value = name;
    document.getElementById('editGradeSchool').value = schoolId;
    document.getElementById('editGradeForm').action = `/admin/grades/edit/${id}`;
    new bootstrap.Modal(document.getElementById('editGradeModal')).show();
}
</script>
{% endblock %}
{% endblock %}
