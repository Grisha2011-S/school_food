
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Анализатор питания по фото</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loader-overlay { display: none; }
        form.loading .loader-overlay { display: flex; }
        form.loading button { pointer-events: none; opacity: 0.7; }
    </style>
</head>
<body class="bg-slate-50">

<div class="min-h-screen flex flex-col items-center p-4 sm:p-6">
    <div class="w-full max-w-2xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-slate-800">Анализатор питания</h1>
            <p class="mt-2 text-lg text-slate-600">Узнайте КБЖУ вашего блюда по одной фотографии!</p>
        </header>

        <main>
            {% with messages = get_flashed_messages() %}
                {% if messages %}
                    <div class="mb-4 max-w-lg mx-auto text-center bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg" role="alert">
                        {% for message in messages %}
                           <p>{{ message }}</p>
                        {% endfor %}
                    </div>
                {% endif %}
            {% endwith %}

            <form id="upload-form" method="post" enctype="multipart/form-data" class="w-full max-w-lg mx-auto">
                <div class="relative">
                    <label for="file-upload" class="cursor-pointer bg-white rounded-xl border-2 border-dashed border-slate-300 hover:border-sky-500 transition-colors p-4 w-full flex flex-col items-center justify-center text-center aspect-video">
                        <div id="image-preview" class="w-full h-full flex flex-col items-center justify-center">
                             {% if filename %}
                                <img src="{{ url_for('static', filename='uploads/' + filename) }}" alt="Загруженное изображение" class="max-h-full max-w-full object-contain rounded-lg">
                            {% else %}
                                <div id="upload-prompt" class="text-slate-500 flex flex-col items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-12 h-12 text-slate-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                                    <span class="font-semibold text-slate-600">Нажмите, чтобы загрузить</span>
                                    <span class="text-sm">или перетащите фото сюда</span>
                                </div>
                            {% endif %}
                        </div>
                    </label>
                    <input id="file-upload" name="file" type="file" class="hidden" accept="image/*">
                    <div class="loader-overlay absolute inset-0 bg-white/80 backdrop-blur-sm flex-col items-center justify-center rounded-xl z-10">
                        <svg class="animate-spin h-10 w-10 text-sky-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        <p class="mt-4 text-slate-600 font-medium">Анализирую... Это может занять несколько секунд.</p>
                    </div>
                </div>
                 <div class="text-center mt-6">
                    <button type="submit" class="bg-sky-600 text-white font-bold py-3 px-8 rounded-lg shadow-md hover:bg-sky-700 focus:outline-none focus:ring-4 focus:ring-sky-300 transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        Анализировать фото
                    </button>
                </div>
            </form>

            {% if data %}
                {% if data.foodName == 'Еда не найдена' or data.calories == 0 %}
                    <div class="w-full max-w-lg mx-auto mt-8 bg-white p-6 rounded-xl shadow-md text-center">
                         <h2 class="text-2xl font-bold text-slate-700">{{ data.foodName }}</h2>
                         <p class="text-slate-500 mt-2">Не удалось определить еду на изображении. Пожалуйста, попробуйте другое фото.</p>
                    </div>
                {% else %}
                    <div class="w-full max-w-lg mx-auto mt-8 bg-white p-6 rounded-xl shadow-md">
                        <h2 class="text-3xl font-bold text-center text-slate-800 mb-1">{{ data.foodName }}</h2>
                        <p class="text-center text-slate-500 mb-6">Пищевая ценность на порцию ({{ data.servingSize }})</p>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                            <div class="flex flex-col items-center p-3 bg-orange-50 rounded-lg">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-orange-500 mb-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z" /><path d="M15.5 8.5c-.75-2-2.5-3-4.5-3s-3.75 1-4.5 3" /><path d="M8.5 15.5c2 1.5 4 1.5 6 0" /></svg>
                                <span class="text-xl font-bold text-orange-600">{{ data.calories | round | int }}</span>
                                <span class="text-sm text-slate-600">Калории</span>
                            </div>
                            <div class="flex flex-col items-center p-3 bg-sky-50 rounded-lg">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-sky-500 mb-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" /><polyline points="22 4 12 14.01 9 11.01" /></svg>
                                <span class="text-xl font-bold text-sky-600">{{ "%.1f"|format(data.protein) }} г</span>
                                <span class="text-sm text-slate-600">Белки</span>
                            </div>
                            <div class="flex flex-col items-center p-3 bg-amber-50 rounded-lg">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-amber-500 mb-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0L12 2.69z" /></svg>
                                <span class="text-xl font-bold text-amber-600">{{ "%.1f"|format(data.fat) }} г</span>
                                <span class="text-sm text-slate-600">Жиры</span>
                            </div>
                            <div class="flex flex-col items-center p-3 bg-lime-50 rounded-lg">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-lime-500 mb-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.4 2.4a2 2 0 0 1 3.2 0l5.6 8.2a2 2 0 0 1-1.6 3.4H6.4a2 2 0 0 1-1.6-3.4Z" /><path d="m12 14 1 7" /><path d="m7 21 1.5-7" /><path d="m17 21-1.5-7" /></svg>
                                <span class="text-xl font-bold text-lime-600">{{ "%.1f"|format(data.carbohydrates) }} г</span>
                                <span class="text-sm text-slate-600">Углеводы</span>
                            </div>
                        </div>
                    </div>
                {% endif %}
            {% endif %}
        </main>
    </div>
</div>

<script>
    const fileInput = document.getElementById('file-upload');
    const imagePreview = document.getElementById('image-preview');
    const form = document.getElementById('upload-form');
    const submitBtn = form.querySelector('button[type="submit"]');
    const dropZone = document.querySelector('label[for="file-upload"]');

    function handleFileSelect(file) {
        if (file) {
            const reader = new FileReader();
            reader.onload = e => {
                imagePreview.innerHTML = `<img src="${e.target.result}" alt="Предпросмотр" class="max-h-full max-w-full object-contain rounded-lg">`;
            }
            reader.readAsDataURL(file);
            submitBtn.disabled = false;
        }
    }

    fileInput.addEventListener('change', (event) => handleFileSelect(event.target.files[0]));
    
    dropZone.addEventListener('drop', (e) => {
        // Файлы из drop event находятся в e.dataTransfer.files
        // Input.files не обновляется автоматически при drop'е на label
        const file = e.dataTransfer.files[0];
        if (file) {
           // Чтобы форма могла отправить файл, его нужно добавить в input
           fileInput.files = e.dataTransfer.files;
           handleFileSelect(file);
        }
    });

    form.addEventListener('submit', function(event) {
        if (fileInput.files.length > 0) {
            form.classList.add('loading');
        } else {
            event.preventDefault();
            // Эта проверка - запасной вариант, т.к. кнопка должна быть неактивна
            alert("Пожалуйста, выберите файл для анализа.");
        }
    });
</script>

</body>
</html>
